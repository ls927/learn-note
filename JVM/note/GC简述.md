# Garbage Collection
:raised_hand_with_fingers_splayed: Let's talk about the garbage

åƒåœ¾æ”¶é›†ï¼ˆå›æ”¶ï¼‰ï¼Œå³é‡Šæ”¾æ‰ä¸€éƒ¨åˆ†ä¸éœ€è¦çš„å†…å­˜ç©ºé—´ã€‚è¿™é‡Œæœ‰ä¸‰ä¸ªåŸºæœ¬é—®é¢˜éœ€è¦è§£å†³ï¼š
- å“ªé‡Œéœ€è¦è¿›è¡Œåƒåœ¾å›æ”¶ï¼Ÿ
- ä½•æ—¶è¿›è¡Œå›æ”¶ï¼Ÿ
- æ€æ ·å›æ”¶ï¼Ÿ

å›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œç¡®å®šæˆ‘ä»¬çš„**è®¨è®ºèŒƒå›´**ï¼š

å½“ä¸‹æˆ‘ä»¬äº†è§£äº† JVM å†…å­˜ç»“æ„ï¼Œè¿™é‡Œæœ‰ä¸‰å—åŒºåŸŸæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼š**è™šæ‹Ÿæœºæ ˆ**ï¼Œ**æœ¬åœ°æ–¹æ³•æ ˆ**å’Œ**ç¨‹åºè®¡æ•°å™¨**ã€‚ç”±äºåœ¨åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œåˆ†é…ç»™å®ƒä»¬çš„ç©ºé—´å¤§å°
æ˜¯ç¡®å®šçš„ã€‚å®ƒä»¬çš„ç©ºé—´åˆ†é…å’Œé‡Šæ”¾ç”±çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå†³å®šï¼Œå…·æœ‰ä¸€ç§ç¡®å®šæ€§ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬çš„å…³æ³¨ç‚¹å¹¶ä¸åœ¨è¿™ï¼Œè€Œæ˜¯åœ¨å…·æœ‰ä¸ç¡®å®šæ€§ï¼ŒåŠ¨æ€å˜åŒ–çš„ **å †** å’Œ **æ–¹æ³•åŒº**ã€‚

## å¯¹è±¡å·²äº¡ï¼Ÿ
ç¡®å®šå“ªäº›å¯¹è±¡å·²ç»æ­»äº¡ï¼Œæ˜¯åƒåœ¾å›æ”¶å‰é¡»åšçš„åˆ¤æ–­ã€‚

> ä¸¤ç§ç®—æ³•

:triangular_flag_on_post: Reference Countingâ€”â€”å¼•ç”¨è®¡æ•°æ³•

ä¸€ç§ç®€å•çš„ç®—æ³•ï¼šæ¯ä¸ªå¯¹è±¡ç»‘å®šä¸€ä¸ªè®¡æ•°å™¨ï¼Œå½“å¯¹è±¡è¢«å¼•ç”¨ï¼ˆä¾èµ–ï¼‰æ—¶ï¼Œè®¡æ•°å™¨è®¡æ•°åŠ  1ï¼Œè¢«å–æ¶ˆå¼•ç”¨æ—¶ï¼Œè®¡æ•°å™¨å‡ 1ï¼Œè®¡æ•°å™¨çš„è®¡æ•°ä¸º 0 æ—¶å³åˆ¤å®šè¯¥å¯¹è±¡å·²æ­»äº¡ã€‚è¿™ç§ç®—æ³•åœ¨å¾ˆå¤šåœ°æ–¹è¢«
åŠ ä»¥é™åˆ¶åœ°ä½¿ç”¨ï¼Œä½†æ˜¯å•çº¯çš„ç®—æ³•æ— æ³•è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œå¯¼è‡´å¤šä¸ªå¯¹è±¡æ°¸è¿œä¸ä¼šè¢«å›æ”¶ï¼Œåœ¨ Hotpot ä¸­ï¼Œè¿™ä¸ªç®—æ³•å¹¶ä¸è¢«é‡‡ç”¨ï¼Œå¯ä»¥é€šè¿‡ç¼–å†™å¾ªç¯ä¾èµ–æ¥éªŒè¯[^1]

:triangular_flag_on_post: Reachability Analysisâ€”â€”å¯è¾¾æ€§åˆ†æ

å¯è¾¾ï¼Œä»€ä¹ˆå¯è¾¾ä»€ä¹ˆï¼Ÿé€‰å–äº†ä¸€ç»„å¯¹è±¡ä½œä¸ºä¸º GC rootsï¼ˆæ ¹ï¼‰ï¼ŒæŸä¸ªå¯¹è±¡ç›´æ¥æˆ–é—´æ¥ï¼ˆæ²¿ç€ Reference Chainï¼‰è¢« GC roots å¯¹è±¡å¼•ç”¨ï¼Œå³ä¸º GC roots å¯è¾¾ï¼ˆable to reachï¼‰ã€‚
é¦–å…ˆåº”è¯¥æŒ‡æ˜ä»€ä¹ˆæ˜¯ GC roots çš„èŒƒå›´ï¼Œæˆ–è€…å“ªäº›å¯¹è±¡å±äº GC rootsï¼š
- è™šæ‹Ÿæœºæ ˆä¸­è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œä¾‹å¦‚æ–¹æ³•çš„å±€éƒ¨å˜é‡ï¼Œä¸´æ—¶å˜é‡åŠå‚æ•°ç­‰
- æ–¹æ³•åŒºä¸­çš„ç±»é™æ€å˜é‡å¼•ç”¨çš„å¯¹è±¡
- æœ¬åœ°æ–¹æ³•æ ˆä¸­å¼•ç”¨çš„å¯¹è±¡
- è¢« syn é”ä½çš„å¯¹è±¡
- JVM å†…éƒ¨å¼•ç”¨ï¼Œå¦‚åŸºæœ¬æ•°æ®ç±»å‹çš„ Classå¯¹è±¡ï¼Œç±»åŠ è½½å™¨

GC roots éšç€ç¨‹åºçš„è¿è¡Œä¼šåŠ¨æ€åŠ å…¥æˆ–åˆ é™¤ä¸€äº›å¯¹è±¡ã€‚

ä¸å¯è¾¾çš„å¯¹è±¡ï¼Œä¼šè¢«åˆ—å…¥"å¾…å›æ”¶"çš„æ¸…å•ï¼Œä½†å¹¶ä¸ä»£è¡¨ç«‹é©¬æ¸…é™¤ï¼Œæ›´åŠ è¯¦ç»†çš„è¿‡ç¨‹ä¸‹æ–¹ä¼šè¿›è¡Œè®¨è®ºã€‚

## è°ˆè°ˆå‡ ç§å¼•ç”¨ç±»å‹
æ—©æœŸçš„å¼•ç”¨è¢«ç®€å•çš„åŒºåˆ†ä¸º"è¢«å¼•ç”¨"å’Œ"ä¸è¢«å¼•ç”¨"ï¼Œè¿™ç§åŒºåˆ†å¯¹äºæœ‰äº›"é£Ÿä¹‹æ— å‘³å¼ƒä¹‹å¯æƒœ"çš„å¯¹è±¡æ— æ³•åšå‡ºå†³ç­–:disappointed_relieved: æ‰€ä»¥å°†å¼•ç”¨ç±»å‹å†è¿›è¡Œä¸€æ¬¡ç»†åˆ†ï¼Œä»¥é¢å¯¹ä¸åŒé‡è¦
ç¨‹åº¦çš„å¯¹è±¡ï¼š

:one: å¼ºå¼•ç”¨ï¼šæ™®é€šçš„å¼•ç”¨ï¼Œæ¯”å¦‚ ```Object o = new Object();``` o ä¸ºä¸€ä¸ªå¼ºå¼•ç”¨ã€‚å¼ºå¼•ç”¨æ°¸è¿œä¸ä¼šè¢« GC å›æ”¶æ‰ã€‚

2ï¸âƒ£ è½¯å¼•ç”¨ï¼š å¼•ç”¨ä¸€äº›**æœ‰ç”¨ä½†éå¿…é¡»**çš„å¯¹è±¡ï¼Œåœ¨ OOM å‘ç”Ÿå‰ï¼Œè¿›è¡ŒäºŒæ¬¡å›æ”¶æ—¶ä¼šå°†è½¯å¼•ç”¨çš„å¯¹è±¡å›æ”¶æ‰ã€‚

3ï¸âƒ£ å¼±å¼•ç”¨ï¼šå¼•ç”¨ä¸€äº›**éå¿…é¡»**çš„å¯¹è±¡ï¼Œä¸€æ¬¡å›æ”¶å³å¯å›æ”¶è¿™äº›å¯¹è±¡ã€‚

4ï¸âƒ£ è™šå¼•ç”¨ï¼šå¼•ç”¨ä¸€äº›æ²¡æœ‰**å®è´¨æ€§ä½œç”¨**çš„å¯¹è±¡ï¼Œæ— æ³•é€šè¿‡è™šå¼•ç”¨å¾—åˆ°å¯¹è±¡ï¼Œå”¯ä¸€ä½œç”¨æ˜¯åœ¨å…¶å…³è”çš„å¯¹è±¡åœ¨è¢«å›æ”¶æ—¶å‘ä¸ªé€šçŸ¥

## å¯¹è±¡ç”Ÿä¸æ­»â€”â€”å›æ”¶è¿‡ç¨‹
:triangular_flag_on_post: ç»è¿‡å¯è¾¾æ€§åˆ†æï¼Œåˆ¤å®šä¸ºä¸å¯è¾¾ï¼Œè¿›è¡Œæ ‡è®°

:triangular_flag_on_post: æ‰«æåˆ°ä¸å¯è¾¾æ ‡è®°å¯¹è±¡ï¼Œæ£€æŸ¥å…¶æ˜¯å¦==è¦†ç›–äº† finalize() æ–¹æ³• ==æˆ–== æœªæ‰§è¡Œè¿‡ finalize() æ–¹æ³• ==ï¼Œè‹¥æ˜¯ï¼Œå°†å…¶ä¸¢è¿›ä¸€ä¸ªå« F-Queue çš„é˜Ÿåˆ—ï¼Œå†è¿›è¡Œæ‰«æç„¶å
æ‰§è¡Œå…¶finalize() æ–¹æ³•â€”â€”è¿™å°†æ˜¯å¯¹è±¡æœ€åçš„å­˜æ´»æœºä¼šï¼Œå¦‚æœå…¶åœ¨é‡å†™çš„ finalize() æ–¹æ³•ä¸­ï¼Œå°†è‡ªå·±ä¸ GC roots Reference Chain æŒ‚é’©ï¼Œå°±å¯é¿å…è¢«å›æ”¶[^2]ï¼›è‹¥å¦,åˆ™ç›´æ¥å›æ”¶ã€‚

æ³¨æ„ï¼š
- è¿™é‡Œå°†æœ‰ä¸€ä¸ªä¼˜å…ˆçº§è¾ƒä½çš„ finalizer çº¿ç¨‹ä¾æ¬¡æ‰§è¡Œ F-Queue ä¸­å¯¹è±¡çš„ finalize() æ–¹æ³•ï¼Œä½†å®ƒä¸ä¿è¯æ–¹æ³•çš„æ˜¯å¦è¢«å®Œå…¨æ‰§è¡Œï¼Œè¿™æ˜¯ä¸ºäº†é¿å…çº¿ç¨‹é™·å…¥æŸä¸ªå¯¹è±¡å›æ”¶æ—¶çš„å±éšœè€Œå¯¼è‡´åƒåœ¾å›æ”¶
é˜»å¡
- finalize() æ–¹æ³•åªèƒ½è¢«æ‰§è¡Œä¸€æ¬¡ã€‚

å¯è§ï¼Œå›æ”¶è¿‡ç¨‹å¹¶ä¸æ˜¯ç›´æ¥å°† å¯¹è±¡ "åˆ¤æ­»"ï¼Œè€Œæ˜¯"æ­»ç¼“"ï¼Œå³å¤šæ¬¡æ ‡è®°å"åˆ¤æ­»"ã€‚

## åƒåœ¾å›æ”¶ç®—æ³•

> åˆ†ä»£æ”¶é›†ç†è®º
> 
> å‡è¯´ 1ï¼šå¼±åˆ†ä»£å‡è¯´ï¼Œç»å¤§å¤šæ•°å¯¹è±¡éƒ½æ˜¯"æœç”Ÿå¤•æ­»" ğŸ³ï¸
> 
> å‡è¯´ 2ï¼šå¼ºåˆ†ä»£å‡è¯´ï¼Œç†¬è¿‡GCæ¬¡æ•°è¶Šå¤šï¼Œç”Ÿå­˜æœºä¼šè¶Šå¤§ï¼Œ"å¤§éš¾ä¸æ­»ï¼Œå¿…æœ‰åç¦" ğŸ™
> 
> å‡è¯´ 3ï¼šè·¨ä»£å¼•ç”¨å‡è¯´ï¼Œæºäºä»¥ä¸Šä¸¤ç§å‡è¯´ï¼Œè·¨ä»£å¼•ç”¨åœ¨åŒä»£ä¸­å æå°‘æ•°ï¼Œè·¨ä»£å¼•ç”¨ä¸­çš„è·¨ä»£ç»ˆæˆåŒä»£ï¼Œè¶‹å‘åŒç”Ÿå…±æ­»ï¼"æœ‰æƒ…äººç»ˆæˆçœ·å±" â™¥ï¸
> 
> è·¨ä»£å¼•ç”¨æ—¶ï¼Œæ¯”å¦‚å¼ºåˆ†ä»£å¼•ç”¨å¼±åˆ†ä»£ï¼Œè¿›è¡Œ MinorGC å›æ”¶å¼±åˆ†ä»£æ—¶ï¼Œå¾€å¾€é™¤äº†æ‰«æå¼±åˆ†ä»£è¿›è¡Œå¯è¾¾æ€§åˆ†æï¼Œè¿˜è¦æ‰«æå¼ºåˆ†ä»£ï¼Œå°†è¢«å¼ºåˆ†ä»£å¼•ç”¨çš„å¼±åˆ†ä»£åŠ å…¥ GC roots
> è¿™æ ·æ•ˆç‡å¤ªä½ï¼Œå¯ä»¥åœ¨å¼±åˆ†ä»£ä¸­ç»´æŠ¤ä¸€ä¸ª remember set æ¥è®°å½•å“ªäº›å¼ºåˆ†ä»£å¼•ç”¨å¼±åˆ†ä»£ï¼Œè¿™æ ·åœ¨ Minor GC æ—¶å¯ä»¥ä¸æ‰«æ å¼ºåˆ†ä»£ã€‚

> æ³¨æ˜ï¼š
> 
> æœ‰ä¸¤ç§ GC
> 
> ğŸš© Patial GC
> 
>   ğŸ”´ Minoor/Young GC: é’ˆå¯¹æ–°ç”Ÿä»£
> 
>   ğŸ”´ Major/Old GC: é’ˆå¯¹è€å¹´ä»£
> 
>   ğŸ”´ Mixed GCï¼šæ··åˆå›æ”¶
> 
> ğŸš© Full GC

ç®—æ³•ï¼š

ğŸš© æ ‡è®°-æ¸…é™¤ï¼ˆMark-Sweepï¼‰

ğŸš© æ ‡è®°-å¤åˆ¶ï¼ˆMark-Copyï¼‰

ğŸš© æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰

[^1]:è¯¦ç»†çš„ä»£ç è§ [src/ReferenceCountingGC.java](../src/ReferenceCountingGC.java)
[^2]:[src/FinalizeEscapeGC.java](../src/FinalizeEscapeGC.java) æ¼”ç¤ºäº†ä¸€ä¸ªå¯¹è±¡çš„ä¸€æ¬¡è‡ªæ•‘è¿‡ç¨‹
